<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medidino - Gesti√≥n de Receta M√©dica</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nueva-receta.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Header / Navbar -->
    <header class="header">
        <div class="header-container">
            <button class="menu-toggle" id="menuToggle">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="header-title">M√ìDULO EMISI√ìN Y SEGUIMIENTO - GESTI√ìN DE RECETA M√âDICA</h1>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fas fa-stethoscope"></i>
                <span>Medidino</span>
            </div>
            <button class="close-sidebar" id="closeSidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('index') }}" class="nav-item nav-back">
                <i class="fas fa-arrow-left"></i>
                <span>Volver al Men√∫ Principal</span>
            </a>
            <hr style="border: 1px solid #E0E6ED; margin: 0.5rem 0;">
            <a href="#inicio" class="nav-item active">
                <i class="fas fa-home"></i>
                <span>Inicio</span>
            </a>
            <a href="{{ url_for('nueva_receta') }}" class="nav-item">
                <i class="fas fa-prescription"></i>
                <span>Gesti√≥n de Receta M√©dica</span>
            </a>
            <a href="{{ url_for('historial') }}" class="nav-item">
                <i class="fas fa-history"></i>
                <span>Historial</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Banner Section -->
        <section class="banner">
            <div class="banner-content">
                <div class="banner-logo">
                    <i class="fas fa-prescription"></i>
                    <h2>Gesti√≥n de Receta M√©dica</h2>
                </div>
                <div class="banner-actions">
                    <a class="btn-secondary" href="{{ url_for('index') }}">
                        <i class="fas fa-arrow-left"></i> Volver al Inicio
                    </a>
                </div>
            </div>
        </section>

        <!-- Content Container -->
        <div class="content-container">
            <!-- Informaci√≥n del M√©dico Logueado (Autom√°tica) -->
            <!-- Eliminado card de m√©dico activo: ahora se selecciona en el formulario -->

            <!-- B√∫squeda de Paciente - Dise√±o Mejorado -->
            <div class="search-hero-section">
                <div class="search-hero-content">
                    <div class="search-hero-header">
                        <div class="search-icon-wrapper">
                            <i class="fas fa-user-md"></i>
                        </div>
                        <div class="search-hero-text">
                            <h2>Gesti√≥n de Recetas M√©dicas</h2>
                            <p>Busque un paciente para ver su historial y gestionar sus recetas</p>
                        </div>
                    </div>
                    
                    <div class="search-box-modern">
                        <div class="search-input-modern">
                            <i class="fas fa-id-card search-input-icon"></i>
                            <input 
                                type="text" 
                                id="buscarPacienteId" 
                                placeholder="Ingrese el n√∫mero de c√©dula del paciente..."
                                autocomplete="off"
                            >
                            <button type="button" class="btn-search-modern" onclick="buscarPacienteYRecetas()">
                                <i class="fas fa-search"></i>
                                <span>Buscar Paciente</span>
                            </button>
                        </div>
                        
                        <div class="search-suggestions">
                            <span class="suggestion-label">
                                <i class="fas fa-lightbulb"></i> C√©dulas de prueba:
                            </span>
                            <button type="button" class="suggestion-chip" onclick="document.getElementById('buscarPacienteId').value='1234567'; buscarPacienteYRecetas();">
                                1234567
                            </button>
                            <button type="button" class="suggestion-chip" onclick="document.getElementById('buscarPacienteId').value='2345678'; buscarPacienteYRecetas();">
                                2345678
                            </button>
                            <button type="button" class="suggestion-chip" onclick="document.getElementById('buscarPacienteId').value='3456789'; buscarPacienteYRecetas();">
                                3456789
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Paciente y Sus Recetas (Se muestra despu√©s de buscar) -->
            <div id="pacienteRecetasContainer" style="display: none;">
                
                <!-- Tarjeta de Informaci√≥n del Paciente -->
                <div class="card paciente-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-user-injured"></i> Informaci√≥n del Paciente
                        </h3>
                        <button class="btn-nueva-receta" onclick="mostrarFormularioNuevaReceta()">
                            <i class="fas fa-plus"></i> Nueva Receta para este Paciente
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="paciente-info-grid">
                            <div class="info-item">
                                <label><i class="fas fa-user"></i> Nombre Completo:</label>
                                <span id="pacienteNombreInfo">---</span>
                            </div>
                            <div class="info-item">
                                <label><i class="fas fa-id-card"></i> Identificaci√≥n:</label>
                                <span id="pacienteIdInfo">---</span>
                            </div>
                            <div class="info-item">
                                <label><i class="fas fa-birthday-cake"></i> Edad:</label>
                                <span id="pacienteEdadInfo">---</span>
                            </div>
                            <div class="info-item">
                                <label><i class="fas fa-venus-mars"></i> G√©nero:</label>
                                <span id="pacienteGeneroInfo">---</span>
                            </div>
                            <div class="info-item">
                                <label><i class="fas fa-phone"></i> Tel√©fono:</label>
                                <span id="pacienteTelefonoInfo">---</span>
                            </div>
                            <div class="info-item">
                                <label><i class="fas fa-envelope"></i> Email:</label>
                                <span id="pacienteEmailInfo">---</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Historial de Recetas del Paciente -->
                <div class="card historial-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-history"></i> Historial de Recetas
                            <span class="badge-count" id="totalRecetasPaciente">0</span>
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="recetas-timeline" id="recetasTimeline">
                            <!-- Se llena din√°micamente con las recetas del paciente -->
                            <div class="timeline-placeholder">
                                <i class="fas fa-prescription"></i>
                                <p>No se encontraron recetas para este paciente</p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Formulario de Nueva Receta / Editar Receta (Modal/Card oculto inicialmente) -->
            <div class="card form-card" id="formularioRecetaCard" style="display: none;">
                <div class="card-header">
                    <h3 class="card-title" id="tituloFormularioReceta">
                        <i class="fas fa-file-medical"></i> Nueva Receta M√©dica
                    </h3>
                    <button class="btn-close-form" onclick="cerrarFormularioReceta()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>

                    <form id="formNuevaReceta" class="form-receta">
                        <!-- Secci√≥n: Informaci√≥n del Paciente -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-user-injured"></i> Informaci√≥n del Paciente
                            </h4>
                            
                            <div class="form-row">
                                <div class="form-group form-group-lg">
                                    <label for="buscarPacienteId" class="required">Buscar Paciente por ID</label>
                                    <div class="input-with-icon" style="position: relative;">
                                        <i class="fas fa-id-card"></i>
                                        <input 
                                            type="text" 
                                            id="buscarPacienteId" 
                                            name="buscarPacienteId" 
                                            placeholder="Ingrese n√∫mero de identificaci√≥n del paciente..."
                                            required
                                            autocomplete="off"
                                        >
                                        <button type="button" id="btnBuscarPaciente" class="btn-search-inline">
                                            <i class="fas fa-search"></i> Buscar
                                        </button>
                                    </div>
                                    <small class="form-hint">
                                        <i class="fas fa-info-circle"></i> 
                                        Ingrese el n√∫mero de c√©dula o identificaci√≥n del paciente y presione Buscar
                                    </small>
                                </div>
                            </div>

                            <!-- Datos Completos del Paciente (se muestran al seleccionar) -->
                            <div id="datosPacienteContainer" style="display: none;">
                                <input type="hidden" id="pacienteIdHidden">
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="pacienteNombre">Nombre Completo</label>
                                        <input type="text" id="pacienteNombre" placeholder="Nombre del paciente">
                                    </div>
                                    <div class="form-group">
                                        <label for="pacienteIdentificacion">Identificaci√≥n</label>
                                        <input type="text" id="pacienteIdentificacion" placeholder="C√©dula o documento">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="pacienteEdad">Edad</label>
                                        <input type="number" id="pacienteEdad" placeholder="Edad">
                                    </div>
                                    <div class="form-group">
                                        <label for="pacienteGenero">G√©nero</label>
                                        <select id="pacienteGenero">
                                            <option value="">Seleccione...</option>
                                            <option value="Masculino">Masculino</option>
                                            <option value="Femenino">Femenino</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="pacienteTelefono">Tel√©fono</label>
                                        <input type="tel" id="pacienteTelefono" placeholder="N√∫mero de contacto">
                                    </div>
                                    <div class="form-group">
                                        <label for="pacienteCorreo">Correo Electr√≥nico</label>
                                        <input type="email" id="pacienteCorreo" placeholder="correo@ejemplo.com">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="pacienteDireccion">Direcci√≥n</label>
                                    <input type="text" id="pacienteDireccion" placeholder="Direcci√≥n completa del paciente">
                                </div>

                                <!-- Bot√≥n para guardar cambios del paciente -->
                                <div style="text-align: right; margin-top: 1rem;">
                                    <button type="button" class="btn-primary" onclick="guardarCambiosPaciente()">
                                        <i class="fas fa-save"></i> Guardar Cambios del Paciente
                                    </button>
                                </div>

                                <div class="alert-info">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Nota:</strong> Los datos del paciente se pueden modificar aqu√≠. Los cambios se actualizar√°n en el sistema.
                                </div>
                            </div>
                            <!-- Selecci√≥n de M√©dico (tra√≠da desde m√≥dulo PHP) -->
                            <div class="form-row" style="margin-top: 0; margin-bottom: 2rem;">
                                <div class="form-group form-group-lg" style="width:100%; background:#eaf6fb; border:2px solid #3498db; border-radius:8px; padding:1rem;">
                                    <label for="selectMedico" style="font-size:1.2rem; font-weight:bold; color:#2980b9; margin-bottom:0.5rem; display:block;">
                                        <i class="fas fa-user-md"></i> Seleccione el m√©dico que emite la receta
                                    </label>
                                    <select id="selectMedico" name="selectMedico" style="width:100%; padding:0.7rem; font-size:1.1rem; border-radius:6px; border:1px solid #3498db;">
                                        <option value="">Cargando m√©dicos...</option>
                                    </select>
                                    <small class="form-hint" style="color:#2980b9; font-size:1rem; margin-top:0.5rem; display:block;">
                                        <i class="fas fa-info-circle"></i>
                                        Los m√©dicos se obtienen del m√≥dulo de M√©dicos (PHP/XAMPP). Debe seleccionar uno antes de guardar la receta.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Secci√≥n: Medicamentos -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-pills"></i> Prescripci√≥n de Medicamentos
                            </h4>
                            
                            <div id="medicamentosContainer">
                                <!-- Medicamento 1 (por defecto) -->
                                <div class="medicamento-item" data-index="0">
                                    <div class="medicamento-header">
                                        <h5><i class="fas fa-capsules"></i> Medicamento #1</h5>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group form-group-lg">
                                            <label for="medicamento_0" class="required">Medicamento</label>
                                            <div class="input-with-icon">
                                                <i class="fas fa-prescription-bottle"></i>
                                                <select id="medicamento_0" name="medicamento[]" required>
                                                    <option value="">Cargando medicamentos disponibles...</option>
                                                </select>
                                            </div>
                                            <small class="form-hint">
                                                <i class="fas fa-info-circle"></i> 
                                                Los medicamentos se cargan desde el inventario (M√≥dulo Grupo 1)
                                            </small>
                                        </div>
                                        <div class="form-group">
                                            <label for="dosis_0" class="required">Dosis</label>
                                            <input type="text" id="dosis_0" name="dosis[]" placeholder="Ej: 500mg" required>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="frecuencia_0" class="required">Frecuencia</label>
                                            <input type="text" id="frecuencia_0" name="frecuencia[]" placeholder="Ej: Cada 8 horas" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="duracion_0" class="required">Duraci√≥n</label>
                                            <input type="text" id="duracion_0" name="duracion[]" placeholder="Ej: 7 d√≠as" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="cantidad_0" class="required">Cantidad</label>
                                            <input type="number" id="cantidad_0" name="cantidad[]" min="1" placeholder="Ej: 20" required>
                                            <small class="form-hint" style="font-size: 0.75rem; color: #666;">
                                                <i class="fas fa-box"></i> Unidades a dispensar
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button type="button" class="btn-add-medicamento" id="btnAgregarMedicamento">
                                <i class="fas fa-plus-circle"></i> Agregar Otro Medicamento
                            </button>
                        </div>

                        <!-- Secci√≥n: Observaciones -->
                        <div class="form-section">
                            <h4 class="section-title">
                                <i class="fas fa-notes-medical"></i> Observaciones Adicionales
                            </h4>
                            <div class="form-group">
                                <label for="observaciones">Observaciones (Opcional)</label>
                                <textarea id="observaciones" name="observaciones" rows="4" 
                                          placeholder="Ingrese observaciones adicionales, recomendaciones especiales o indicaciones para el paciente..."></textarea>
                                <small class="form-hint">
                                    <i class="fas fa-info-circle"></i> 
                                    M√°ximo 500 caracteres
                                </small>
                            </div>
                        </div>

                        <!-- Secci√≥n: Estado de la Receta (Solo visible en modo edici√≥n) -->
                        <div class="form-section" id="seccionEstadoReceta" style="display: none;">
                            <h4 class="section-title">
                                <i class="fas fa-toggle-on"></i> Estado de la Receta
                            </h4>
                            <div class="form-row">
                                <div class="form-group form-group-lg">
                                    <label for="estadoReceta" class="required">Estado Actual</label>
                                    <div class="input-with-icon">
                                        <i class="fas fa-info-circle"></i>
                                        <select id="estadoReceta" name="estadoReceta">
                                            <option value="Activa">‚úÖ Activa</option>
                                            <option value="Dispensada">üì¶ Dispensada</option>
                                            <option value="Cancelada">‚ùå Cancelada</option>
                                            <option value="Vencida">‚è∞ Vencida</option>
                                        </select>
                                    </div>
                                    <small class="form-hint">
                                        <i class="fas fa-info-circle"></i> 
                                        Seleccione el estado actual de la receta
                                    </small>
                                </div>
                                <div class="form-group form-group-lg">
                                    <label for="motivoCambioEstado">Motivo del cambio de estado</label>
                                    <input type="text" id="motivoCambioEstado" name="motivoCambioEstado" 
                                           placeholder="Ej: Paciente complet√≥ el tratamiento">
                                    <small class="form-hint">
                                        <i class="fas fa-comment-dots"></i> 
                                        Explique brevemente por qu√© cambi√≥ el estado
                                    </small>
                                </div>
                            </div>
                            <div class="alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>Importante:</strong> El cambio de estado quedar√° registrado en el historial de cambios de la receta.
                            </div>
                        </div>

                        <!-- Botones de Acci√≥n -->
                        <div class="form-actions">
                            <label class="checkbox-inline" style="display:flex; align-items:center; gap:0.5rem;">
                                <input type="checkbox" id="enviarNotificacion" checked>
                                <span>Enviar notificaci√≥n al paciente</span>
                            </label>
                            <div style="flex:1"></div>
                            <button type="button" class="btn-cancel" id="btnCancelar">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                            <button type="button" class="btn-clear" id="btnLimpiar">
                                <i class="fas fa-eraser"></i> Limpiar Formulario
                            </button>
                            <button type="submit" class="btn-submit">
                                <i class="fas fa-check-circle"></i> Generar Receta
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Panel de Vista Previa (opcional) -->
                <div class="card preview-card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-eye"></i> Vista Previa de la Receta
                        </h3>
                    </div>
                    <div class="preview-content" id="vistaPrevia">
                        <div class="preview-placeholder">
                            <i class="fas fa-file-prescription"></i>
                            <p>Complete el formulario para ver la vista previa de la receta</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Overlay for mobile sidebar -->
    <div class="overlay" id="overlay"></div>

    <!-- Modal de Confirmaci√≥n -->
    <div class="modal" id="modalConfirmacion">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-check-circle"></i> Receta Generada Exitosamente</h3>
            </div>
            <div class="modal-body">
                <p>La receta m√©dica ha sido generada y guardada correctamente.</p>
                <p><strong>N√∫mero de Receta:</strong> <span id="numeroReceta">RX-2025-0001</span></p>
                <p><strong>Fecha:</strong> <span id="fechaReceta"></span></p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="cerrarModal()">
                    <i class="fas fa-times"></i> Cerrar
                </button>
                <button class="btn-primary" onclick="imprimirReceta()">
                    <i class="fas fa-print"></i> Imprimir Receta
                </button>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/nueva-receta.js') }}?v=27"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Script de verificaci√≥n -->
    <script>
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üîç VERIFICACI√ìN DE FUNCIONES');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('‚úì buscarPacienteYRecetas existe:', typeof buscarPacienteYRecetas);
        console.log('‚úì mostrarNotificacion existe:', typeof mostrarNotificacion);
        console.log('‚úì mostrarInfoPaciente existe:', typeof mostrarInfoPaciente);
        console.log('‚úì mostrarHistorialRecetas existe:', typeof mostrarHistorialRecetas);
        console.log('‚úì Campo buscarPacienteId:', document.getElementById('buscarPacienteId'));
        console.log('‚úì Container pacienteRecetasContainer:', document.getElementById('pacienteRecetasContainer'));
        console.log('‚úì Timeline recetasTimeline:', document.getElementById('recetasTimeline'));
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üîç VERIFICACI√ìN DEL SIDEBAR');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('‚úì menuToggle:', document.getElementById('menuToggle'));
        console.log('‚úì sidebar:', document.getElementById('sidebar'));
        console.log('‚úì closeSidebar:', document.getElementById('closeSidebar'));
        console.log('‚úì overlay:', document.getElementById('overlay'));
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    </script>
</body>
</html>
