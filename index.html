<!DOCTYPE html>
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="refresh" content="0;url=/" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Medidino ‚Äî redirigiendo...</title>
  </head>
        <body>
        <div class="container" style="max-width: 500px; margin: 40px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 2rem;">
            <h1 style="text-align:center; margin-bottom: 2rem; color: #2c3e50;">Bienvenido a Medidino</h1>
            <div class="card" style="padding: 1.5rem; border-radius: 8px; background: #f8f9fa;">
                <h2 style="margin-bottom: 1rem; color: #34495e;">Seleccione el m√©dico para trabajar</h2>
                <div style="margin-bottom: 1.5rem;">
                    <label for="selectMedicoHome" style="font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem; display: block;">M√©dico:</label>
                    <select id="selectMedicoHome" style="width: 100%; padding: 0.7rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc;">
                        <option value="">Cargando m√©dicos...</option>
                    </select>
                </div>
                <button id="btnContinuarMedico" class="btn-primary" style="width: 100%; padding: 0.8rem; font-size: 1.1rem; background: #2980b9; color: #fff; border: none; border-radius: 6px; cursor: pointer;">Continuar</button>
            </div>
        </div>
        <script>
            // Cargar m√©dicos desde PHP
            async function cargarMedicosHome() {
                const select = document.getElementById('selectMedicoHome');
                select.innerHTML = '<option value="">Cargando m√©dicos...</option>';
                try {
                    const resp = await fetch('http://localhost/Medidino_recetas/backend/medicos.php');
                    const json = await resp.json();
                    const medicos = (json && json.data) ? json.data : [];
                    if (!Array.isArray(medicos) || medicos.length === 0) {
                        select.innerHTML = '<option value="">No se encontraron m√©dicos</option>';
                        return;
                    }
                    select.innerHTML = '<option value="">-- Seleccione un m√©dico --</option>';
                    medicos.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = m.id_medico || m.id || '';
                        const nombreCompleto = [m.nombre, m.apellido].filter(Boolean).join(' ');
                        const especialidad = m.nombre_especialidad ? ` ‚Äî ${m.nombre_especialidad}` : '';
                        opt.textContent = `${nombreCompleto}${especialidad}`;
                        select.appendChild(opt);
                    });
                } catch (err) {
                    select.innerHTML = '<option value="">Error al cargar m√©dicos</option>';
                }
            }
            document.addEventListener('DOMContentLoaded', cargarMedicosHome);

            // Guardar selecci√≥n en localStorage y continuar
            document.getElementById('btnContinuarMedico').onclick = function() {
                const select = document.getElementById('selectMedicoHome');
                const idMedico = select.value;
                if (!idMedico) {
                    alert('Seleccione un m√©dico antes de continuar');
                    return;
                }
                localStorage.setItem('medicoSeleccionado', idMedico);
                window.location.href = '/nueva-receta';
            };
        </script>
    </body>
</html>
                nombre: "Juan Carlos Garc√≠a L√≥pez",
                identificacion: "2345678",
                telefono: "302-345-6789",
                fechaNacimiento: "1983-05-20"
            },
            "3456789": {
                id: 3,
                nombre: "Mar√≠a Sof√≠a Rodr√≠guez Mart√≠nez",
                identificacion: "3456789",
                telefono: "303-456-7890",
                fechaNacimiento: "1997-08-12"
            }
        };

        // Funci√≥n para buscar y cargar paciente
        function buscarYCargarPaciente() {
            const cedula = document.getElementById('buscarPacienteCedula').value.trim();
            
            if (!cedula) {
                alert('‚ö†Ô∏è Por favor ingrese un n√∫mero de c√©dula');
                return;
            }

            console.log('üîç Buscando paciente con c√©dula:', cedula);

            // Buscar en la base de datos
            const paciente = pacientesIndexDB[cedula];
            
            if (paciente) {
                console.log('‚úÖ Paciente encontrado:', paciente);
                
                // Mostrar card de paciente encontrado
                const pacienteBox = document.getElementById('pacienteEncontradoBox');
                if (pacienteBox) {
                    pacienteBox.style.display = 'block';
                    document.getElementById('pacienteNombreMostrar').textContent = paciente.nombre;
                    document.getElementById('pacienteCedulaMostrar').textContent = paciente.identificacion;
                    document.getElementById('pacienteTelefonoMostrar').textContent = paciente.telefono;
                    document.getElementById('pacienteIdHidden').value = paciente.id;
                }
                
                // Pre-llenar los campos del formulario
                document.getElementById('nombrePaciente').value = paciente.nombre;
                document.getElementById('identificacionPaciente').value = paciente.identificacion;
                document.getElementById('fechaNacimiento').value = paciente.fechaNacimiento || '';
                document.getElementById('telefonoPaciente').value = paciente.telefono;
                
                // Mostrar todo el contenido del formulario
                const contenedor = document.getElementById('contenidoFormularioReceta');
                if (contenedor) {
                    contenedor.style.display = 'block';
                    
                    // Auto-completar fecha de emisi√≥n
                    const fechaInput = document.getElementById('fechaEmision');
                    if (fechaInput) {
                        const hoy = new Date().toISOString().split('T')[0];
                        fechaInput.value = hoy;
                    }
                    
                    // Scroll suave
                    setTimeout(() => {
                        contenedor.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
                
                alert('‚úÖ Paciente encontrado: ' + paciente.nombre + '\n\nDatos cargados. Complete la receta.');
                
            } else {
                console.log('‚ùå Paciente NO encontrado');
                alert('‚ùå Paciente no encontrado\n\nLa c√©dula ' + cedula + ' no est√° registrada.\n\nRegistre al paciente en el m√≥dulo de Gesti√≥n de Pacientes.');
                
                document.getElementById('pacienteEncontradoBox').style.display = 'none';
                document.getElementById('contenidoFormularioReceta').style.display = 'none';
            }
        }

        // Funci√≥n para limpiar
        function limpiarPaciente() {
            document.getElementById('buscarPacienteCedula').value = '';
            document.getElementById('pacienteEncontradoBox').style.display = 'none';
            const contenedor = document.getElementById('contenidoFormularioReceta');
            if (contenedor) {
                contenedor.style.display = 'none';
            }
        }

        // Permitir buscar con Enter
        document.addEventListener('DOMContentLoaded', function() {
            const campoCedula = document.getElementById('buscarPacienteCedula');
            if (campoCedula) {
                campoCedula.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        buscarYCargarPaciente();
                    }
                });
            }

            // Manejar env√≠o del formulario de nueva receta
            const formReceta = document.getElementById('nuevaRecetaForm');
            if (formReceta) {
                formReceta.addEventListener('submit', function(e) {
                    e.preventDefault();
                    guardarReceta();
                });
            }
        });

        // Funci√≥n para guardar la receta
        function guardarReceta() {
            // Validar que haya un paciente
            const pacienteId = document.getElementById('pacienteIdHidden')?.value;
            const nombrePaciente = document.getElementById('nombrePaciente').value.trim();
            
            if (!pacienteId && !nombrePaciente) {
                alert('‚ö†Ô∏è Debe buscar o registrar un paciente primero');
                return;
            }

            // Obtener datos del formulario
            const fechaEmision = document.getElementById('fechaEmision').value;
            const diagnostico = document.getElementById('diagnostico').value.trim();
            const medicamento = document.getElementById('medicamentoNombre').value.trim();
            const dosis = document.getElementById('dosis').value.trim();
            const duracion = document.getElementById('duracion').value.trim();
            const observaciones = document.getElementById('observaciones').value.trim();

            // Validaciones b√°sicas
            if (!fechaEmision || !diagnostico || !medicamento || !dosis || !duracion) {
                alert('‚ö†Ô∏è Por favor complete todos los campos obligatorios');
                return;
            }

            // Generar n√∫mero de receta
            const numeroReceta = 'RX-' + new Date().getFullYear() + '-' + String(Math.floor(Math.random() * 10000)).padStart(5, '0');

            // Crear objeto de receta
            const receta = {
                numero_receta: numeroReceta,
                fecha_emision: fechaEmision,
                diagnostico: diagnostico,
                observaciones: observaciones,
                estado: 'Pendiente',
                paciente: {
                    id: pacienteId || null,
                    nombre: nombrePaciente,
                    identificacion: document.getElementById('identificacionPaciente').value,
                    telefono: document.getElementById('telefonoPaciente').value
                },
                medicamento: {
                    nombre: medicamento,
                    dosis: dosis,
                    duracion: duracion
                }
            };

            console.log('üìã Receta generada:', receta);

            // Aqu√≠ ir√≠a la llamada al backend
            // fetch('/api/recetas', { method: 'POST', body: JSON.stringify(receta) })

            // Simular guardado exitoso
            alert('‚úÖ Receta guardada exitosamente!\n\n' +
                  'N√∫mero de Receta: ' + numeroReceta + '\n' +
                  'Paciente: ' + nombrePaciente + '\n' +
                  'Medicamento: ' + medicamento + '\n\n' +
                  'La receta ha sido registrada en el sistema.');

            // Preguntar si quiere crear otra o ver el historial
            const respuesta = confirm('¬øDesea crear otra receta?\n\n' +
                                     'Presione OK para crear otra receta\n' +
                                     'Presione Cancelar para ver el historial');

            if (respuesta) {
                // Limpiar formulario
                limpiarFormularioReceta();
            } else {
                // Ir al historial
                window.location.href = '/historial';
            }
        }

        // Funci√≥n para limpiar el formulario
        function limpiarFormularioReceta() {
            document.getElementById('buscarPacienteCedula').value = '';
            document.getElementById('pacienteEncontradoBox').style.display = 'none';
            document.getElementById('contenidoFormularioReceta').style.display = 'none';
            document.getElementById('nuevaRecetaForm').reset();
        }
    </script>

    <style>
        .btn-secondary:hover {
            background: #5a6268 !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
    </style>
</body>
</html>
